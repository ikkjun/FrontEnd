<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Game</title>
  <style>
    img {
      width : 80px;
      height : 120px;
    }
  </style>
</head>
<body>
  <button id="hide">뒤집기</button>
  <button id="show">보이기</button>
  <button id="shuffle">섞기</button>
  <button id="hint">힌트</button>
  정답 수: <span id="answerCount"></span><br>
  
  <div id="board">
  </div>
  <script>
    let cardArr = [];
    let selectedCard = [];
    let tmpCardArr = [];  // 힌트에 사용될 임시 배열

    let answer = 0;

    window.onload = function() {
      // 버튼 참조 가져오기
      let hide = document.getElementById("hide");
      let show = document.getElementById("show");
      let shuffle = document.getElementById("shuffle");
      let hint = document.getElementById("hint");
      // board 태그 가져오기
      let board = document.getElementById("board");
      // img 태그 가져오기
      let images = document.getElementsByTagName("img");
      // answer 태그 가져오기
      let answerCount = document.getElementById("answerCount");
      // answer 태그에 answer 자식 노드로 추가
      answerCount.innerHTML = answer;

      // 1. 배열 초기화
      initializeCard();

      // 2. 버튼에 이벤트 등록
      hide.addEventListener('click', flipAllCards);
      show.addEventListener("click", backtoFront);
      shuffle.addEventListener("click",shuffleCard);
      hint.addEventListener("click", giveHint);

      // 3. 카드에 이벤트 등록
      for(let i=0;i<images.length;i++) {
        images[i].addEventListener("click",cardClick);
      }
    }

    // 열거형으로 패턴 선언
    const Pattern = {
      DIAMOND : "diamond",
      CLOVER : "clover",
      HEART : "heart",
      SPADE : "spade",
    };

    // 열거형으로 숫자 선언
    const NUM = {
      ONE:"1", TWO:"2", THREE:"3",
      FOUR:"4", FIVE:"5", SIX:"6",
      SEVEN:"7", EIGHT:"8", NINE:"9",
      TEN:"10", ELEVEN:"11", TWELEVE:"12",
      THIRTEEN:"13"
    };
    
    // 카드 초기화
    function initializeDeck() {
      let idx = 0 // 사진 번호
      for(p in Pattern) {
        for (n in NUM) {
          // 카드 생성자
          cardArr.push(new Card(p,n, idx++));
        }
      }
    }

    function initializeCard() {
      initializeDeck(); // 첫 번째 덱
      initializeDeck(); // 두 번째 덱

      // board에 이미지 추가
      showCard();
    }

    // Card 생성자.
    function Card(p, n, idx) {
      let pattern = p;
      let num = n;
      let index = idx;

      // 패턴 얻는 함수
      this.getPattern = function () {
        return Pattern[pattern];
      };

      // 숫자 얻는 함수
      this.getNum = function () {
        return NUM[num];
      }

      // 사진의 인덱스 얻는 함수
      this.getIndex = function () {
        return index;
      }
    }

    function cardClick(event) {
      // 1. 카드가 앞면인지 확인. 앞면이면 return
      let card = event.target;
      if(isFront(card)) return;
      // 2. 카드 뒤집기
      flip(card);
      // 선택된 카드 배열 선언
      // 처음 클릭한 카드 배열에 추가
      selectedCard.push(card);
      tmpCardArr.push(card);
      if(selectedCard.length%2 === 0) {
        checkCard(selectedCard[0], selectedCard[1]);
        selectedCard = [];
      }
    }

    function checkCard(firstCard, secondCard) {
      let imageArr = Array.from(document.getElementsByTagName("img"));  // 이미지 태그 가져오기
      let answerCount = document.getElementById("answerCount");
      
      let firstCardIndex = imageArr.indexOf(firstCard);
      let secondCardIndex = imageArr.indexOf(secondCard);

      let first = cardArr[firstCardIndex];
      let second = cardArr[secondCardIndex];
      // pattern, number 비교
      if ((first.getPattern() === second.getPattern()) // 패턴 확인
          && (first.getNum() === second.getNum())) {  // 숫자 확인
            // 점수 올라가기
            answerCount.innerHTML = ++answer;
          } else {
            console.log("before delete tmpCardArr.length(): " + tmpCardArr.length);
            // 패턴이 다르면 뒤에서 두 개 삭제
            tmpCardArr.splice(tmpCardArr.length-2,2);
            console.log("after delete tmpCardArr.length(): " + tmpCardArr.length);

            // 다르면 0.5초 뒤에 다시 뒤집기
            setTimeout(() => {
              imageArr[firstCardIndex].setAttribute("src", "back.png");
              imageArr[secondCardIndex].setAttribute("src", "back.png");
            }, 500);
          }
    }

    function flip(card) {
      // 해당되는 배열에 getIndex 사용해서 그림 보여주기
      let imageArr = Array.from(document.getElementsByTagName("img"));
      let index = imageArr.indexOf(card);
      let cardIndex = cardArr[index].getIndex();
      card.setAttribute("src", cardIndex + ".png");
    }
    
    // 카드가 앞면이면 true, 아니면 false
    function isFront(card) {
      let src = card.getAttribute("src");
      if(src.indexOf('back') === -1) {
        return true; // 앞면
      } else {
        return false;  // 뒷면
      }
    }

    // 앞면이 두 개인지 확인하는 함수
    function isFrontTwo() {
      let cnt = 0;
      let images = document.getElementsByTagName("img");
      for (let i=0;i<images.length;i++) {
        if(isFront(images[i])) cnt++;
      }
      return cnt === 2;
    }

    // 모든 카드를 뒤집는 함수. 
    function flipAllCards() {
      let images = document.getElementsByTagName("img");
      for (let i=0;i<images.length;i++) {
        images[i].setAttribute("src","back.png")
      }
    }

    // 카드를 보여주는 함수
    function backtoFront() {
      let images = document.getElementsByTagName("img");
      for (let i=0;i<images.length;i++) {
        images[i].setAttribute("src", cardArr[i].getIndex() + ".png");
      }
      // 정답 초기화
      iniAnswerCount();
    }

    // 카드를 섞는 함수
    function shuffleCard() {
      cardArr.sort((a,b) => Math.random() - 0.5);
      let board = document.getElementById("board");
      let images = document.getElementsByTagName("img");
      for(let i=images.length-1; i>=0;i--) {
        board.removeChild(images[i]);
      }

      // board에 이미지 추가
      showCard();
      
      // 섞은 후에 이미지 태그에 대한 클릭 이벤트 다시 등록
      for(let i=0;i<images.length;i++) {
        images[i].addEventListener("click", cardClick);
      }

      // 정답 초기화
      iniAnswerCount();
    }

    // board에 이미지 추가하는 함수
    function showCard() {
      for(let i=0 ; i<cardArr.length ; i++) {
        let img = document.createElement('img');
        img.setAttribute("src", cardArr[i].getIndex() + ".png");
        board.appendChild(img);
      }
      // img.addEventListener("click",cardClick);
    }

    // 정답 수 초기화하는 함수
    function iniAnswerCount () {
      let answerCount = document.getElementById("answerCount");
      answer = 0;
      answerCount.innerHTML = answer;
    }

    // 힌트를 주는 함수
    function giveHint () {
      let imgArr = Array.from(document.getElementsByTagName('img'));
      
      // 전체 보여주기
      for (let i=0;i<cardArr.length;i++) {
        imgArr[i].setAttribute("src", cardArr[i].getIndex() + ".png");
      }

      // 3초 뒤에 원래 뒤집어진 카드 제외하고 다시 뒤집기
      setTimeout(() => {
        // 선택된 카드가 홀수라면 배열의 마지막 요소 삭제
        if(tmpCardArr.length%2===1) {
          tmpCardArr.pop();
          selectedCard=[];
        }

        // 전체 카드 - 뒤집혀진 카드 배열 선언
        let difImg = imgArr.filter(x => !tmpCardArr.includes(x)); 
        for (let i=0;i<difImg.length;i++) {
          difImg[i].setAttribute("src", "back.png");
        }
      }, 3000);

      // 힌트 준 뒤 카드에 이벤트 다시 등록
      let images = document.getElementsByTagName("img");
      for(let i=0;i<images.length;i++) {
        images[i].addEventListener("click", cardClick);
      }
    }
  </script>
</body>
</html>